# ðŸš€ å…«å¦è¿åŠ¿å°ç¨‹åº - ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²æŒ‡å— 2025

> åŸºäºŽDockerçš„è…¾è®¯äº‘ç”Ÿäº§çŽ¯å¢ƒå®Œæ•´éƒ¨ç½²æ–¹æ¡ˆï¼Œæ”¯æŒå‰åŽç«¯åˆ†ç¦»ã€å¾®æœåŠ¡æž¶æž„

---

## ðŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æž¶æž„](#æŠ€æœ¯æž¶æž„)
3. [æœåŠ¡å™¨å‡†å¤‡](#æœåŠ¡å™¨å‡†å¤‡)
4. [çŽ¯å¢ƒå˜é‡é…ç½®](#çŽ¯å¢ƒå˜é‡é…ç½®)
5. [Dockeréƒ¨ç½²](#dockeréƒ¨ç½²)
6. [å‰ç«¯éƒ¨ç½²](#å‰ç«¯éƒ¨ç½²)
7. [SSLè¯ä¹¦é…ç½®](#sslè¯ä¹¦é…ç½®)
8. [ç›‘æŽ§å‘Šè­¦](#ç›‘æŽ§å‘Šè­¦)
9. [è¿ç»´æŒ‡å—](#è¿ç»´æŒ‡å—)

---

## ðŸŽ¯ é¡¹ç›®æ¦‚è¿°

å…«å¦è¿åŠ¿æ˜¯åŸºäºŽAIçš„å‘½ç†æµ‹ç®—å¾®ä¿¡å°ç¨‹åºï¼Œé‡‡ç”¨çŽ°ä»£åŒ–äº‘åŽŸç”Ÿæž¶æž„è®¾è®¡ã€‚

### ðŸ—ï¸ æŠ€æœ¯æž¶æž„

#### å‰ç«¯æž¶æž„
- **å°ç¨‹åº**: UniApp + Vue3 + TypeScript
- **ç‰ˆæœ¬**: uni-app 3.0.0-4060620250520001
- **æž„å»º**: Vite 5.4.19
- **éƒ¨ç½²**: é™æ€èµ„æºCDN + Nginx

#### åŽç«¯æž¶æž„
- **æ¡†æž¶**: Spring Boot 2.7.14
- **æ•°æ®åº“**: MySQL 8.0 + MyBatis-Plus
- **ç¼“å­˜**: Redis 7.0
- **æ¶ˆæ¯**: RabbitMQ (å¯é€‰)
- **éƒ¨ç½²**: Docker + Docker Compose

#### åŸºç¡€è®¾æ–½
- **æœåŠ¡å™¨**: è…¾è®¯äº‘CVM (4C8G)
- **å®¹å™¨**: Docker + Docker Compose
- **è´Ÿè½½å‡è¡¡**: Nginx
- **CDN**: è…¾è®¯äº‘CDN
- **å­˜å‚¨**: è…¾è®¯äº‘COS
- **ç›‘æŽ§**: Prometheus + Grafana

---

## ðŸ–¥ï¸ æœåŠ¡å™¨å‡†å¤‡

### æŽ¨èé…ç½®

#### åŸºç¡€é…ç½®
- **CPU**: 4æ ¸å¿ƒåŠä»¥ä¸Š
- **å†…å­˜**: 8GBåŠä»¥ä¸Š
- **ç¡¬ç›˜**: 100GB SSD
- **å¸¦å®½**: 5MbpsåŠä»¥ä¸Š
- **ç³»ç»Ÿ**: Ubuntu 20.04 LTS

#### å®‰å…¨é…ç½®
- **é˜²ç«å¢™**: ä»…å¼€æ”¾å¿…è¦ç«¯å£ (22, 80, 443)
- **SSH**: ç¦ç”¨å¯†ç ç™»å½•ï¼Œä½¿ç”¨å¯†é’¥è®¤è¯
- **ç”¨æˆ·**: åˆ›å»ºç‹¬ç«‹çš„éƒ¨ç½²ç”¨æˆ·
- **å¤‡ä»½**: é…ç½®è‡ªåŠ¨æ•°æ®å¤‡ä»½

### çŽ¯å¢ƒåˆå§‹åŒ–

```bash
# 1. æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# 2. å®‰è£…åŸºç¡€å·¥å…·
sudo apt install -y curl wget git vim htop unzip tree jq

# 3. é…ç½®æ—¶åŒº
sudo timedatectl set-timezone Asia/Shanghai

# 4. åˆ›å»ºéƒ¨ç½²ç”¨æˆ·
sudo useradd -m -s /bin/bash deploy
sudo usermod -aG sudo deploy
sudo su - deploy

# 5. é…ç½®SSHå¯†é’¥ï¼ˆæ›¿æ¢ä¸ºæ‚¨çš„å…¬é’¥ï¼‰
mkdir -p ~/.ssh
echo "your-ssh-public-key" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh
```

### DockerçŽ¯å¢ƒå®‰è£…

```bash
# 1. å®‰è£…Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker deploy

# 2. å®‰è£…Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 3. é…ç½®Dockeré•œåƒåŠ é€Ÿ
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json > /dev/null <<EOF
{
    "registry-mirrors": [
        "https://mirror.ccs.tencentcloudcr.com",
        "https://ccr.ccs.tencentcloudcr.com"
    ],
    "log-driver": "json-file",
    "log-opts": {
        "max-size": "100m",
        "max-file": "3"
    },
    "storage-driver": "overlay2"
}
EOF

# 4. é‡å¯DockeræœåŠ¡
sudo systemctl daemon-reload
sudo systemctl restart docker
sudo systemctl enable docker

# 5. éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

---

## ðŸ”§ çŽ¯å¢ƒå˜é‡é…ç½®

### åˆ›å»ºç”Ÿäº§çŽ¯å¢ƒé…ç½®æ–‡ä»¶

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
sudo mkdir -p /opt/fortune-app
sudo chown deploy:deploy /opt/fortune-app
cd /opt/fortune-app

# ä¸Šä¼ é¡¹ç›®ä»£ç ï¼ˆä½¿ç”¨Gitæˆ–SCPï¼‰
git clone https://github.com/your-repo/bagua-ai.git .
# æˆ–è€…
# scp -r ./bagua-ai/ deploy@server-ip:/opt/fortune-app/

# åˆ›å»ºç”Ÿäº§çŽ¯å¢ƒå˜é‡æ–‡ä»¶
cat > .env.prod << 'EOF'
# ===========================================
# å…«å¦è¿åŠ¿å°ç¨‹åºç”Ÿäº§çŽ¯å¢ƒé…ç½®
# åˆ›å»ºæ—¶é—´: 2025-06-05
# ===========================================

# åº”ç”¨ä¿¡æ¯
APP_NAME=fortune-mini-app
APP_VERSION=1.0.0
APP_ENV=production

# æ•°æ®åº“é…ç½®
MYSQL_ROOT_PASSWORD=FortuneProd2025!@#$%^&*()
MYSQL_DATABASE=fortune_db
MYSQL_USERNAME=fortune_user
MYSQL_PASSWORD=FortuneProd2025User!@#$
MYSQL_HOST=mysql-prod
MYSQL_PORT=3306

# Redisé…ç½®
REDIS_HOST=redis-prod
REDIS_PORT=6379
REDIS_PASSWORD=RedisProd2025!@#$%^&*()
REDIS_DATABASE=0

# åº”ç”¨å®‰å…¨é…ç½®
JWT_SECRET=FortuneJWTSecretKeyForProductionEnvironment2025!@#$%^&*()ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789
ENCRYPTION_KEY=FortuneEncryption2025!@#$%^&*()

# DeepSeek AIé…ç½®
DEEPSEEK_API_KEY=sk-161f80e197f64439a4a9f0b4e9e30c40
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
DEEPSEEK_MODEL=deepseek-chat

# å¾®ä¿¡å°ç¨‹åºé…ç½®
WECHAT_APP_ID=wx7fafb8277143634d
WECHAT_APP_SECRET=your-wechat-app-secret

# å¾®ä¿¡æ”¯ä»˜é…ç½®ï¼ˆå¯é€‰ï¼‰
WECHAT_PAY_APP_ID=wx7fafb8277143634d
WECHAT_PAY_MCH_ID=your-merchant-id
WECHAT_PAY_API_KEY=your-pay-api-key
WECHAT_PAY_NOTIFY_URL=https://your-domain.com/api/payment/notify

# æœåŠ¡ç«¯å£é…ç½®
SERVER_PORT=8080
MANAGEMENT_PORT=8081
NGINX_HTTP_PORT=80
NGINX_HTTPS_PORT=443

# åŸŸåé…ç½®
DOMAIN_NAME=your-domain.com
SSL_EMAIL=your-email@domain.com

# æ—¥å¿—é…ç½®
LOG_LEVEL=INFO
LOG_PATH=/opt/fortune-app/logs

# æ–‡ä»¶ä¸Šä¼ é…ç½®
UPLOAD_PATH=/opt/fortune-app/uploads
MAX_FILE_SIZE=10MB

# ç›‘æŽ§é…ç½®
PROMETHEUS_PORT=9090
GRAFANA_PORT=3000
GRAFANA_ADMIN_PASSWORD=GrafanaAdmin2025!@#

# å¤‡ä»½é…ç½®
BACKUP_SCHEDULE=0 2 * * *
BACKUP_RETENTION_DAYS=30
BACKUP_PATH=/opt/fortune-app/backup
EOF

# è®¾ç½®æƒé™
chmod 600 .env.prod
```

### å®‰å…¨é…ç½®éªŒè¯

```bash
# ç”Ÿæˆå¼ºéšæœºå¯†ç 
generate_password() {
    openssl rand -base64 32 | tr -d "=+/" | cut -c1-25
}

# éªŒè¯å¿…éœ€çŽ¯å¢ƒå˜é‡
check_env() {
    local required_vars=(
        "MYSQL_ROOT_PASSWORD"
        "MYSQL_PASSWORD"
        "JWT_SECRET"
        "DEEPSEEK_API_KEY"
        "WECHAT_APP_ID"
        "WECHAT_APP_SECRET"
    )
    
    for var in "${required_vars[@]}"; do
        if [ -z "${!var}" ]; then
            echo "é”™è¯¯: çŽ¯å¢ƒå˜é‡ $var æœªè®¾ç½®"
            exit 1
        fi
    done
}
```

---

## ðŸ³ Dockeréƒ¨ç½²

### æ›´æ–°Docker Composeé…ç½®

åˆ›å»ºä¼˜åŒ–çš„ç”Ÿäº§çŽ¯å¢ƒé…ç½®ï¼š

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  # MySQLæ•°æ®åº“ - ç”Ÿäº§çŽ¯å¢ƒ
  mysql-prod:
    image: mysql:8.0
    container_name: fortune-mysql-prod
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USERNAME}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    ports:
      - "127.0.0.1:3306:3306"  # ä»…å†…ç½‘è®¿é—®
    volumes:
      - mysql_prod_data:/var/lib/mysql
      - ./backend/src/main/resources/sql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ./mysql/conf.d:/etc/mysql/conf.d:ro
      - ./logs/mysql:/var/log/mysql
    command: |
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --innodb-buffer-pool-size=1024M
      --innodb-log-file-size=256M
      --innodb-flush-log-at-trx-commit=1
      --sync-binlog=1
      --slow-query-log=1
      --slow-query-log-file=/var/log/mysql/slow.log
      --long-query-time=2
      --max-connections=500
      --max-allowed-packet=64M
    networks:
      - fortune-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      timeout: 20s
      retries: 10
      interval: 30s
      start_period: 60s

  # Redisç¼“å­˜ - ç”Ÿäº§çŽ¯å¢ƒ
  redis-prod:
    image: redis:7-alpine
    container_name: fortune-redis-prod
    restart: unless-stopped
    command: |
      redis-server 
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
      --appendonly yes
      --appendfsync everysec
      --tcp-keepalive 60
      --timeout 300
    ports:
      - "127.0.0.1:6379:6379"  # ä»…å†…ç½‘è®¿é—®
    volumes:
      - redis_prod_data:/data
      - ./logs/redis:/var/log/redis
    networks:
      - fortune-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      timeout: 20s
      retries: 5
      interval: 30s

  # åŽç«¯åº”ç”¨ - ç”Ÿäº§çŽ¯å¢ƒ
  backend-prod:
    build: 
      context: ./backend
      dockerfile: Dockerfile
      args:
        - BUILD_ENV=production
    container_name: fortune-backend-prod
    restart: unless-stopped
    ports:
      - "127.0.0.1:8080:8080"  # ä»…å†…ç½‘è®¿é—®
      - "127.0.0.1:8081:8081"  # ç®¡ç†ç«¯ç‚¹
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - MYSQL_HOST=mysql-prod
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - REDIS_HOST=redis-prod
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - WECHAT_APP_ID=${WECHAT_APP_ID}
      - WECHAT_APP_SECRET=${WECHAT_APP_SECRET}
      - WECHAT_PAY_APP_ID=${WECHAT_PAY_APP_ID:-}
      - WECHAT_PAY_MCH_ID=${WECHAT_PAY_MCH_ID:-}
      - WECHAT_PAY_API_KEY=${WECHAT_PAY_API_KEY:-}
      - WECHAT_PAY_NOTIFY_URL=${WECHAT_PAY_NOTIFY_URL:-}
      - JAVA_OPTS=-Xms1024m -Xmx2048m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Xloggc:/app/logs/gc.log
    depends_on:
      mysql-prod:
        condition: service_healthy
      redis-prod:
        condition: service_healthy
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
      - ./ssl:/app/ssl:ro
    networks:
      - fortune-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/actuator/health"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 5m
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535

  # Nginxåå‘ä»£ç† - ç”Ÿäº§çŽ¯å¢ƒ
  nginx-prod:
    image: nginx:1.25-alpine
    container_name: fortune-nginx-prod
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.prod.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./ssl:/etc/nginx/ssl:ro
      - ./logs/nginx:/var/log/nginx
      - ./frontend/dist/build/h5:/usr/share/nginx/html/static:ro
      - ./uploads:/usr/share/nginx/html/uploads:ro
    depends_on:
      - backend-prod
    networks:
      - fortune-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Prometheusç›‘æŽ§
  prometheus:
    image: prom/prometheus:latest
    container_name: fortune-prometheus
    restart: unless-stopped
    ports:
      - "127.0.0.1:9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    networks:
      - fortune-network

  # Grafanaå¯è§†åŒ–
  grafana:
    image: grafana/grafana:latest
    container_name: fortune-grafana
    restart: unless-stopped
    ports:
      - "127.0.0.1:3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - fortune-network

volumes:
  mysql_prod_data:
    driver: local
  redis_prod_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

networks:
  fortune-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
```

### éƒ¨ç½²è„šæœ¬

åˆ›å»ºè‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ï¼š 